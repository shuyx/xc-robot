# RobotSim 机器人仿真模块使用指南

## 概述

RobotSim 是基于 VTK+PyQt5 的机器人仿真模块，为 XC-ROBOT 系统提供了 3D 机器人仿真功能。支持 STL 模型导入、关节角度控制、正逆运动学计算，以及与 FR3 SDK 的集成。

## 功能特性

### 1. 3D 可视化
- 基于 VTK 的 3D 渲染引擎
- 浅色背景设计，提供更好的模型对比度
- 右上角坐标轴指示器，带XYZ字母标注
  - X轴 (红色): 水平方向
  - Y轴 (绿色): 景深前后方向  
  - Z轴 (蓝色): 上下方向
- 清洁的3D场景，专注于机器人模型显示
- 支持网格显示和实时模型变换
- 清晰的界面布局，右侧日志区域宽度优化

### 2. STL 模型支持
- 导入和显示 STL 格式的机器人模型
- 支持FR3机械臂标准命名规则 (参见 `STL_NAMING_GUIDE.md`)
- 模型材质和光照效果
- 支持犀牛导出的高精度STL文件

### 3. 关节控制
- 6 个关节的独立角度控制
- 基于 FR3 机械臂的关节限制
- 实时关节角度显示

### 4. 运动学计算
- 正向运动学：关节角度 → 末端位姿
- 逆运动学：末端位姿 → 关节角度
- 基于 DH 参数的运动学模型

### 5. 末端位姿控制
- 实时末端位姿显示
- 目标位姿设置
- 逆运动学求解

### 6. 预设动作
- 回到原点位置
- 挥手动作演示
- 可扩展的动作库

## 安装要求

### 必需依赖
```bash
pip install vtk>=9.0.0
pip install PyQt5>=5.15.0
pip install numpy>=1.21.0
```

### 推荐依赖
```bash
pip install pyyaml>=6.0     # 配置文件支持
pip install colorlog>=6.0.0 # 日志增强
```

## 使用方法

### 1. 启动仿真系统

#### 方法一：使用启动脚本（推荐）
```bash
# 激活虚拟环境
source venv/bin/activate

# 使用启动脚本
python start_robotsim.py
```

#### 方法二：直接启动
```bash
# 激活虚拟环境
source venv/bin/activate

# 启动主程序
python gui/main_window.py
```

#### 安全退出
- **正常退出**: 点击窗口的关闭按钮
- **终端退出**: 在终端中按 `Ctrl+C` (已优化，会正确清理资源)
- **紧急退出**: 如果程序无响应，使用 `Ctrl+Z` 然后 `kill %1`

### 2. 加载机器人模型
1. **准备STL文件**: 按照 `STL_NAMING_GUIDE.md` 的命名规则准备模型文件
2. 点击"浏览"按钮选择 STL 模型文件 (建议从 `fr3_base.stl` 开始)
3. 点击"加载模型"按钮  
4. 模型将显示在明亮的浅色 3D 视窗中
5. 右上角显示坐标轴指示器:
   - X轴 (红色): 水平方向，标注字母 "X"
   - Y轴 (绿色): 景深前后方向，标注字母 "Y"
   - Z轴 (蓝色): 上下方向，标注字母 "Z"  
   - 会跟随相机视角自动旋转

### 3. 关节角度控制
- 使用滑块调节各关节角度
- 关节角度限制基于 FR3 机械臂规格
- 实时显示当前关节角度

### 4. 末端位姿控制
- 查看"当前位姿"显示实时末端位置和姿态
- 在"目标位姿"区域设置期望的末端位置和姿态
- 点击"移动到目标位姿"执行逆运动学求解

### 5. 预设动作
- "回到原点"：所有关节回到 0° 位置
- "挥手动作"：执行预设的挥手动作序列

## 运动学参数

### FR3 机械臂 DH 参数
```python
# [a, alpha, d, theta_offset]
dh_params = [
    [0,     0,          0.333,    0],      # 关节1
    [0,     -π/2,       0,        0],      # 关节2
    [0,     π/2,        0.316,    0],      # 关节3
    [0.0825, π/2,       0,        0],      # 关节4
    [-0.0825, -π/2,     0.384,    0],      # 关节5
    [0,     0,          0,        0]       # 关节6
]
```

### 关节角度限制
- 关节1: -165° ~ 165°
- 关节2: -110° ~ 110°
- 关节3: -165° ~ 165°
- 关节4: -110° ~ 110°
- 关节5: -165° ~ 165°
- 关节6: -180° ~ 180°

## 文件结构

```
xc-robot/
├── gui/
│   └── widgets/
│       ├── robot_sim_widget.py      # RobotSim 主界面
│       ├── fr3_kinematics.py        # FR3 运动学模型
│       └── ...
├── models/
│   └── fr3_base.stl                 # FR3 基座模型
├── test_robot_sim.py                # 基础测试
├── test_robot_sim_complete.py       # 完整测试
└── requirements.txt                 # 依赖列表
```

## 测试功能

### 基础测试
```bash
python test_robot_sim.py
```

### 完整测试
```bash
python test_robot_sim_complete.py
```

测试内容包括：
- 界面创建
- 运动学模型
- 模型加载
- 关节控制
- 末端位姿控制
- 逆运动学求解
- 预设动作
- 紧急停止

## 扩展功能

### 1. 集成 FR3 SDK
```python
# 在 fr3_kinematics.py 中添加
def connect_fr3_sdk(self):
    """连接 FR3 SDK"""
    # 这里添加 FR3 SDK 连接代码
    pass

def get_real_joint_angles(self):
    """获取真实机械臂关节角度"""
    # 这里添加从 FR3 SDK 获取角度的代码
    pass
```

### 2. 添加碰撞检测
```python
def check_collision(self, joint_angles):
    """检查关节角度是否会导致碰撞"""
    # 这里添加碰撞检测算法
    pass
```

### 3. 轨迹规划
```python
def plan_trajectory(self, start_pose, end_pose):
    """规划机械臂运动轨迹"""
    # 这里添加轨迹规划算法
    pass
```

## 故障排除

### 1. VTK 安装问题
```bash
# 如果 VTK 安装失败，尝试：
pip install --upgrade pip
pip install vtk==9.3.0
```

### 2. 模型加载失败
- 确保 STL 文件格式正确
- 检查文件路径是否存在
- 确认文件读取权限

### 3. 运动学计算错误
- 检查关节角度是否在限制范围内
- 确认 DH 参数设置正确
- 验证目标位姿是否可达

## 开发计划

### 短期目标
- [x] 基本界面和 3D 显示
- [x] STL 模型导入和显示
- [x] 关节角度控制
- [x] 正逆运动学计算
- [x] 末端位姿控制

### 中期目标
- [ ] 真实 FR3 SDK 集成
- [ ] 多部件模型支持
- [ ] 碰撞检测
- [ ] 轨迹规划

### 长期目标
- [ ] 力控制仿真
- [ ] 动力学仿真
- [ ] 虚拟现实支持
- [ ] 机器学习集成

## 贡献指南

欢迎贡献代码和建议！请遵循以下步骤：

1. Fork 项目
2. 创建功能分支
3. 提交变更
4. 创建 Pull Request

## 许可证

本项目采用 MIT 许可证，详见 LICENSE 文件。

## 联系信息

如有问题或建议，请联系开发团队。